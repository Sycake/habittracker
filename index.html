<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multi-Habit Weekly Progress Tracker with Auth</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="page-container">
    <div class="main-content">
      <h1>多习惯进度追踪</h1>

      <div id="authSection">
        <button id="loginBtn">Google 登录</button>
        <button id="logoutBtn" style="display:none">登出</button>
        <p id="userInfo"></p>
      </div>

      <!-- 添加新习惯区域 -->
      <div class="new-event">
        <input type="text" id="newHabitName" placeholder="输入习惯名称">
        <button id="addHabitBtn">添加习惯</button>
      </div>

      <!-- 习惯容器 -->
      <div id="habitsContainer"></div>
    </div>
  </div>

  <!-- Firebase Authentication + Firestore 代码 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, updateDoc, doc,
      serverTimestamp, getDocs, query, orderBy, where
    } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup,
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC8IMOWmeOF9E6xAjTFW_u6ioyC8z4j7t0",
      authDomain: "habit-tracker-8dc7c.firebaseapp.com",
      projectId: "habit-tracker-8dc7c",
      storageBucket: "habit-tracker-8dc7c.appspot.com",
      messagingSenderId: "203345022635",
      appId: "1:203345022635:web:9fc51c0ea40a631e38b1ee",
      measurementId: "G-RHGS9550KB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');

    loginBtn.addEventListener('click', () => signInWithPopup(auth, provider));
    logoutBtn.addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        userInfo.textContent = `当前用户：${user.displayName}`;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline';
        loadHabits(user.uid);
      } else {
        userInfo.textContent = '';
        loginBtn.style.display = 'inline';
        logoutBtn.style.display = 'none';
        document.getElementById('habitsContainer').innerHTML = '<p>请先登录查看习惯</p>';
      }
    });

    async function loadHabits(userId) {
      try {
        const q = query(collection(db, 'habits'), where("createdBy", "==", userId), orderBy('createdAt'));
        const snapshot = await getDocs(q);
        const habitsContainer = document.getElementById('habitsContainer');
        habitsContainer.innerHTML = '';
        snapshot.forEach((docSnap) => {
          const habitData = docSnap.data();
          const habitModule = createHabitProgress(habitData.name);
          habitModule.dataset.docId = docSnap.id;
          habitsContainer.appendChild(habitModule);
          if (Array.isArray(habitData.days)) {
            const checkboxes = habitModule.querySelectorAll('.day input');
            habitData.days.forEach((d, i) => checkboxes[i].checked = d);
          }
          updateHabitProgress(habitModule, false);
        });
      } catch (err) {
        console.error("加载习惯出错", err);
      }
    }

    document.getElementById('addHabitBtn').addEventListener('click', async () => {
      const user = auth.currentUser;
      const nameInput = document.getElementById('newHabitName');
      const name = nameInput.value.trim();
      if (!user) return alert('请先登录');
      if (!name) return;

      const docRef = await addDoc(collection(db, 'habits'), {
        name,
        progress: 0,
        days: [false, false, false, false, false, false, false],
        createdAt: serverTimestamp(),
        createdBy: user.uid
      });

      const habitModule = createHabitProgress(name);
      habitModule.dataset.docId = docRef.id;
      document.getElementById('habitsContainer').appendChild(habitModule);
      nameInput.value = '';
    });

    function createHabitProgress(habitName) {
      const container = document.createElement('div');
      container.className = 'weekly-progress';
      const title = document.createElement('h2');
      title.innerText = habitName;
      const progressBar = document.createElement('div');
      progressBar.className = 'progress-bar';
      const fill = document.createElement('div');
      fill.className = 'progress-bar-fill';
      fill.style.width = '0%';
      progressBar.appendChild(fill);
      const progressText = document.createElement('p');
      progressText.className = 'progress-text';
      progressText.innerText = '进度：0%';
      const daysContainer = document.createElement('div');
      daysContainer.className = 'days';
      const labels = ['一','二','三','四','五','六','日'];
      for (let i = 0; i < 7; i++) {
        const day = document.createElement('div');
        day.className = 'day';
        const label = document.createElement('label');
        label.innerText = '周' + labels[i];
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.addEventListener('change', () => updateHabitProgress(container, true));
        day.appendChild(label);
        day.appendChild(checkbox);
        daysContainer.appendChild(day);
      }
      container.append(title, progressBar, progressText, daysContainer);
      return container;
    }

    async function updateHabitProgress(container, writeToDB = true) {
      const boxes = container.querySelectorAll('input[type="checkbox"]');
      const days = Array.from(boxes).map(b => b.checked);
      const count = days.filter(d => d).length;
      const percent = (count / 7) * 100;
      container.querySelector('.progress-bar-fill').style.width = percent + '%';
      container.querySelector('.progress-text').innerText = '进度：' + Math.round(percent) + '%';
      if (writeToDB && container.dataset.docId) {
        await updateDoc(doc(db, 'habits', container.dataset.docId), {
          days,
          progress: percent,
          updatedAt: serverTimestamp()
        });
      }
    }
  </script>
</body>
</html>
